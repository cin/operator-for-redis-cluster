"use strict";(self.webpackChunkoperator_for_redis_cluster=self.webpackChunkoperator_for_redis_cluster||[]).push([[350],{3905:(e,r,t)=>{t.d(r,{Zo:()=>p,kt:()=>h});var n=t(7294);function a(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function i(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function l(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?i(Object(t),!0).forEach((function(r){a(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function o(e,r){if(null==e)return{};var t,n,a=function(e,r){if(null==e)return{};var t,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)t=i[n],r.indexOf(t)>=0||(a[t]=e[t]);return a}(e,r);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)t=i[n],r.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var s=n.createContext({}),c=function(e){var r=n.useContext(s),t=r;return e&&(t="function"==typeof e?e(r):l(l({},r),e)),t},p=function(e){var r=c(e.components);return n.createElement(s.Provider,{value:r},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var r=e.children;return n.createElement(n.Fragment,{},r)}},m=n.forwardRef((function(e,r){var t=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),u=c(t),m=a,h=u["".concat(s,".").concat(m)]||u[m]||d[m]||i;return t?n.createElement(h,l(l({ref:r},p),{},{components:t})):n.createElement(h,l({ref:r},p))}));function h(e,r){var t=arguments,a=r&&r.mdxType;if("string"==typeof e||a){var i=t.length,l=new Array(i);l[0]=m;var o={};for(var s in r)hasOwnProperty.call(r,s)&&(o[s]=r[s]);o.originalType=e,o[u]="string"==typeof e?e:a,l[1]=o;for(var c=2;c<i;c++)l[c]=t[c];return n.createElement.apply(null,l)}return n.createElement.apply(null,t)}m.displayName="MDXCreateElement"},315:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>s,contentTitle:()=>l,default:()=>d,frontMatter:()=>i,metadata:()=>o,toc:()=>c});var n=t(7462),a=(t(7294),t(3905));const i={title:"Scaling Operations",slug:"/scaling"},l="Scaling Operations",o={unversionedId:"scaling",id:"scaling",title:"Scaling Operations",description:"Overview",source:"@site/docs/scaling.md",sourceDirName:".",slug:"/scaling",permalink:"/operator-for-redis-cluster/scaling",draft:!1,editUrl:"https://cin.github.io/operator-for-redis-cluster/docs/scaling.md",tags:[],version:"current",lastUpdatedAt:1682487089,formattedLastUpdatedAt:"Apr 26, 2023",frontMatter:{title:"Scaling Operations",slug:"/scaling"},sidebar:"docs",previous:{title:"Redis Server Configuration",permalink:"/operator-for-redis-cluster/configuration"},next:{title:"Rolling Update Procedure",permalink:"/operator-for-redis-cluster/rolling-update"}},s={},c=[{value:"Overview",id:"overview",level:2},{value:"Impact of scaling",id:"impact-of-scaling",level:2},{value:"Resource Requirements",id:"resource-requirements",level:3},{value:"Scaling primaries",id:"scaling-primaries",level:2},{value:"Scaling up",id:"scaling-up",level:3},{value:"Example",id:"example",level:4},{value:"Scaling down",id:"scaling-down",level:3},{value:"Example",id:"example-1",level:4},{value:"Scaling replication factor",id:"scaling-replication-factor",level:2},{value:"Scaling up",id:"scaling-up-1",level:3},{value:"Example",id:"example-2",level:4},{value:"Scaling down",id:"scaling-down-1",level:3},{value:"Example",id:"example-3",level:4},{value:"Scaling primaries and replication factor",id:"scaling-primaries-and-replication-factor",level:2},{value:"Example 1",id:"example-1-1",level:4},{value:"Example 2",id:"example-2-1",level:4}],p={toc:c},u="wrapper";function d(e){let{components:r,...t}=e;return(0,a.kt)(u,(0,n.Z)({},p,t,{components:r,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"scaling-operations"},"Scaling Operations"),(0,a.kt)("h2",{id:"overview"},"Overview"),(0,a.kt)("p",null,"There are many reasons why you would want to scale the number of Redis nodes in your cluster. A few of the most common reasons are: "),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Memory pressure - the nodes in your cluster are close to full capacity (or are at fully capacity and evictions are causing the backend to take more traffic than desired)",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Horizontally scale the number of primaries to better serve requests"),(0,a.kt)("li",{parentName:"ul"},"Vertically scale your current Redis nodes by allocating more memory"))),(0,a.kt)("li",{parentName:"ul"},"CPU bottleneck - throughput is low and impacting system performance",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Horizontally scale the number of primaries to better serve requests"),(0,a.kt)("li",{parentName:"ul"},"Vertically scale your current Redis nodes by allocating more CPUs"))),(0,a.kt)("li",{parentName:"ul"},"Over-provisioning - you have allocated too many resources for your cluster",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Scale down if it does not hurt the performance of your system"),(0,a.kt)("li",{parentName:"ul"},"Scale down the number of primaries to save on costs"),(0,a.kt)("li",{parentName:"ul"},"If you are running a Redis cluster with a high replication factor (RF), consider reducing it"),(0,a.kt)("li",{parentName:"ul"},"In multi-zone clusters, scaling down may reduce availability in the case of a zone outage")))),(0,a.kt)("h2",{id:"impact-of-scaling"},"Impact of scaling"),(0,a.kt)("p",null,"Scaling operations happen in real-time while the Redis cluster receives requests. They are computationally intensive, so expect a decrease in performance while the scaling operation takes place. The extent of the performance impact depends on the size of the data stored in Redis, as well as CPU utilization. See ",(0,a.kt)("a",{parentName:"p",href:"/operator-for-redis-cluster/key-migration"},"key migration")," for more information about how Redis keys are migrated from one primary to another during the scaling process."),(0,a.kt)("h3",{id:"resource-requirements"},"Resource Requirements"),(0,a.kt)("p",null,"Like the rolling update procedure, scaling up requires additional resources to create new Redis pods. In the case where there are insufficient resources to schedule new Redis pods, the pods will get stuck in ",(0,a.kt)("inlineCode",{parentName:"p"},"Pending")," state. If you find your newly created pods are in ",(0,a.kt)("inlineCode",{parentName:"p"},"Pending")," state, increase the memory + cpu allocated to your k8s nodes, or add more nodes to your worker pool."),(0,a.kt)("h2",{id:"scaling-primaries"},"Scaling primaries"),(0,a.kt)("p",null,"The first option for scaling your cluster is scaling the number of primaries. You can trigger a scaling operation by modifying the ",(0,a.kt)("inlineCode",{parentName:"p"},"numberOfPrimaries")," field in ",(0,a.kt)("inlineCode",{parentName:"p"},"charts/node-for-redis/values.yaml")," and running ",(0,a.kt)("inlineCode",{parentName:"p"},"helm upgrade")," on your cluster."),(0,a.kt)("h3",{id:"scaling-up"},"Scaling up"),(0,a.kt)("p",null,"Scale up operations take place when the desired number of primaries is greater than the current number of primaries. We take the following actions for scale up operations:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"For the number of primaries added,\n    1. Create a new Redis pod.\n    2. Wait for the pod to become ready.\n\nOnce the number of desired Redis pods matches the current number of running pods,\n    3. Check if we have sufficient primaries. If not, promote replicas to primaries. This only happens when you scale up the number of primaries AND scale down RF.\n    4. Add the new Redis nodes to the selection of current primaries.\n    5. Place and attach replicas to their respective primaries.\n    6. Dispatch slots and migrate keys to the new primaries.\n")),(0,a.kt)("p",null,"After this last step, your cluster will be in normal operating state. The primaries nodes will have an equal number of slots and replica nodes will be properly attached."),(0,a.kt)("h4",{id:"example"},"Example"),(0,a.kt)("p",null,"Given a Redis cluster with the following config:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"numberOfPrimaries: 3\nreplicationFactor: 1\n")),(0,a.kt)("p",null,"Assuming your helm release name is ",(0,a.kt)("inlineCode",{parentName:"p"},"redis-cluster"),", scale up ",(0,a.kt)("inlineCode",{parentName:"p"},"numberOfPrimaries")," by running the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"helm upgrade redis-cluster charts/node-for-redis --set numberOfPrimaries=5\n")),(0,a.kt)("h3",{id:"scaling-down"},"Scaling down"),(0,a.kt)("p",null,"Scale down operations take place when the desired number of primaries is less than the current number of primaries. We take the following actions for scale down operations:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"For the number of primaries deleted,\n    1. Select one primary to remove.\n    2. Migrate keys from the primary to be removed to the other primaries. Slots are equally distributed across the remaining primaries.\n    3. Detach, forget, and delete the primary to be removed.\n\nOnce the number of desired Redis pods matches the current number of running pods,\n    4. Dispatch slots and migrate keys to the new primaries.\n    5. Place and attach replicas to their respective primaries.\n")),(0,a.kt)("p",null,"After this last step, your cluster will be in normal operating state."),(0,a.kt)("h4",{id:"example-1"},"Example"),(0,a.kt)("p",null,"Given a Redis cluster with the following config:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"numberOfPrimaries: 5\nreplicationFactor: 1\n")),(0,a.kt)("p",null,"Scale down ",(0,a.kt)("inlineCode",{parentName:"p"},"numberOfPrimaries")," by running the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"helm upgrade redis-cluster charts/node-for-redis --set numberOfPrimaries=3\n")),(0,a.kt)("h2",{id:"scaling-replication-factor"},"Scaling replication factor"),(0,a.kt)("p",null,"The second option for scaling your cluster is scaling RF. You can trigger a scaling operation by modifying the ",(0,a.kt)("inlineCode",{parentName:"p"},"replicationFactor")," field in ",(0,a.kt)("inlineCode",{parentName:"p"},"charts/node-for-redis/values.yaml")," and running ",(0,a.kt)("inlineCode",{parentName:"p"},"helm upgrade")," on your cluster. "),(0,a.kt)("h3",{id:"scaling-up-1"},"Scaling up"),(0,a.kt)("p",null,"Scale up operations for RF take place when the desired RF is greater than the current RF. We take the following actions for scale up operations:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"For the number of replicas added,\n    1. Create a new Redis pod.\n    2. Wait for the pod to become ready.\n\nOnce the number of desired Redis pods matches the current number of running pods,\n    3. Add the new Redis nodes to the selection of replicas.\n    4. Place and attach replicas to their respective primaries such that each primary has the same number of replicas.\n    5. Dispatch slots and migrate keys to the new primaries.\n")),(0,a.kt)("p",null,"After this step, your cluster will be in normal operating state."),(0,a.kt)("h4",{id:"example-2"},"Example"),(0,a.kt)("p",null,"Given a Redis cluster with the following config:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"numberOfPrimaries: 3\nreplicationFactor: 1\n")),(0,a.kt)("p",null,"Scale up ",(0,a.kt)("inlineCode",{parentName:"p"},"replicationFactor")," by running the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"helm upgrade redis-cluster charts/node-for-redis --set replicationFactor=2\n")),(0,a.kt)("h3",{id:"scaling-down-1"},"Scaling down"),(0,a.kt)("p",null,"Scale down operations for RF take place when the desired RF is less than the current RF. We take the following actions for scale down operations:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"For the number of replicas deleted,\n    For each primary in the cluster,\n        1. Calculate the difference between the current RF and desired RF.\n            2. If we do not have sufficient replicas for this primary, select new replicas and attach them to the primary.\n            3. If we have too many replicas, select replicas to delete. Detach, forget, and delete the replica to be removed.\n    \nOnce the number of desired Redis pods matches the current number of running pods,\n    4. Place and attach replicas to their respective primaries.\n")),(0,a.kt)("p",null,"After this step, your cluster will be in normal operating state."),(0,a.kt)("h4",{id:"example-3"},"Example"),(0,a.kt)("p",null,"Given a Redis cluster with the following config:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"numberOfPrimaries: 3\nreplicationFactor: 2\n")),(0,a.kt)("p",null,"Scale down ",(0,a.kt)("inlineCode",{parentName:"p"},"replicationFactor")," by running the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"helm upgrade redis-cluster charts/node-for-redis --set replicationFactor=1\n")),(0,a.kt)("h2",{id:"scaling-primaries-and-replication-factor"},"Scaling primaries and replication factor"),(0,a.kt)("p",null,"You may scale both the number of primaries and replication factor in a single ",(0,a.kt)("inlineCode",{parentName:"p"},"helm upgrade")," command. The number of pods created or deleted will be calculated and actions will be taken according to the algorithms described in the previous sections. The following is an example of scaling up ",(0,a.kt)("inlineCode",{parentName:"p"},"numberOfPrimaries")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"replicationFactor"),"."),(0,a.kt)("h4",{id:"example-1-1"},"Example 1"),(0,a.kt)("p",null,"Given a Redis cluster with the following config:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"numberOfPrimaries: 3\nreplicationFactor: 1\n")),(0,a.kt)("p",null,"Increase ",(0,a.kt)("inlineCode",{parentName:"p"},"numberOfPrimaries")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"replicationFactor")," by running the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"helm upgrade redis-cluster charts/node-for-redis --set numberOfPrimaries=4 --set replicationFactor=2\n")),(0,a.kt)("hr",null),(0,a.kt)("h4",{id:"example-2-1"},"Example 2"),(0,a.kt)("p",null,"You may also scale up one field while scaling down the other:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"numberOfPrimaries: 4\nreplicationFactor: 2\n")),(0,a.kt)("p",null,"Increase ",(0,a.kt)("inlineCode",{parentName:"p"},"numberOfPrimaries")," and decrease ",(0,a.kt)("inlineCode",{parentName:"p"},"replicationFactor")," by running the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"helm upgrade redis-cluster charts/node-for-redis --set numberOfPrimaries=5 --set replicationFactor=1\n")))}d.isMDXComponent=!0}}]);