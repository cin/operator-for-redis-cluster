"use strict";(self.webpackChunkoperator_for_redis_cluster=self.webpackChunkoperator_for_redis_cluster||[]).push([[571],{906:(e,r,o)=>{o.r(r),o.d(r,{assets:()=>c,contentTitle:()=>i,default:()=>u,frontMatter:()=>l,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"cookbook","title":"Cookbook","description":"Installation","source":"@site/docs/cookbook.md","sourceDirName":".","slug":"/cookbook","permalink":"/operator-for-redis-cluster/cookbook","draft":false,"unlisted":false,"editUrl":"https://cin.github.io/operator-for-redis-cluster/docs/cookbook.md","tags":[],"version":"current","lastUpdatedAt":1749862110000,"frontMatter":{"title":"Cookbook","slug":"/cookbook"},"sidebar":"docs","previous":{"title":"Home","permalink":"/operator-for-redis-cluster/"},"next":{"title":"Kubectl Plugin","permalink":"/operator-for-redis-cluster/kubectl-plugin"}}');var s=o(4848),t=o(8453);const l={title:"Cookbook",slug:"/cookbook"},i="Cookbook",c={},d=[{value:"Installation",id:"installation",level:2},{value:"Required Dependencies",id:"required-dependencies",level:3},{value:"Recommended Dependencies",id:"recommended-dependencies",level:3},{value:"Download and build the source code",id:"download-and-build-the-source-code",level:3},{value:"Create a Kubernetes cluster",id:"create-a-kubernetes-cluster",level:2},{value:"Deploy a Redis operator",id:"deploy-a-redis-operator",level:3},{value:"Notes on Multi-Architecture Builds",id:"notes-on-multi-architecture-builds",level:3},{value:"Deploy a Redis cluster",id:"deploy-a-redis-cluster",level:3},{value:"Clean up your environment",id:"clean-up-your-environment",level:3},{value:"Run end-to-end tests",id:"run-end-to-end-tests",level:2}];function a(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"cookbook",children:"Cookbook"})}),"\n",(0,s.jsx)(r.h2,{id:"installation",children:"Installation"}),"\n",(0,s.jsxs)(r.p,{children:["Operator for Redis Cluster is written in ",(0,s.jsx)(r.a,{href:"https://golang.org/",children:"Go"}),"."]}),"\n",(0,s.jsx)(r.h3,{id:"required-dependencies",children:"Required Dependencies"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.code,{children:"make"})}),"\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.a,{href:"https://golang.org/doc/install",children:"Go 1.17+"})}),"\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.a,{href:"https://www.docker.com/",children:"Docker"})}),"\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.a,{href:"https://helm.sh",children:"Helm 3"})}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"recommended-dependencies",children:"Recommended Dependencies"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.a,{href:"https://kind.sigs.k8s.io/",children:"Kind"})," or ",(0,s.jsx)(r.a,{href:"https://github.com/kubernetes/minikube",children:"Minikube"})]}),"\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.a,{href:"https://github.com/golangci/golangci-lint",children:"golangci-lint"})}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"download-and-build-the-source-code",children:"Download and build the source code"}),"\n",(0,s.jsxs)(r.p,{children:["Start by making a fork of the ",(0,s.jsx)(r.code,{children:"operator-for-redis-cluster"})," repository. Then, clone your forked repo:"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-console",children:"$ git clone git@github.com:<YOUR_USERNAME>/operator-for-redis-cluster.git\nCloning into 'operator-for-redis-cluster'...\n$ cd operator-for-redis-cluster\n"})}),"\n",(0,s.jsx)(r.p,{children:"Build the project:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-console",children:'$ make build\nCGO_ENABLED=0 go build -installsuffix cgo -ldflags "-w -X github.com/IBM/operator-for-redis-cluster/pkg/utils.TAG=0.3.4 -X github.com/IBM/operator-for-redis-cluster/pkg/utils.COMMIT=81c58d3bb6e713679637d9971fc8f795ca5a3e2f -X github.com/IBM/operator-for-redis-cluster/pkg/utils.OPERATOR_VERSION= -X github.com/IBM/operator-for-redis-cluster/pkg/utils.REDIS_VERSION= -X github.com/IBM/operator-for-redis-cluster/pkg/utils.BUILDTIME=2021-10-21/12:44:33 -s" -o bin/operator ./cmd/operator\nCGO_ENABLED=0 go build -installsuffix cgo -ldflags "-w -X github.com/IBM/operator-for-redis-cluster/pkg/utils.TAG=0.3.4 -X github.com/IBM/operator-for-redis-cluster/pkg/utils.COMMIT=81c58d3bb6e713679637d9971fc8f795ca5a3e2f -X github.com/IBM/operator-for-redis-cluster/pkg/utils.OPERATOR_VERSION= -X github.com/IBM/operator-for-redis-cluster/pkg/utils.REDIS_VERSION= -X github.com/IBM/operator-for-redis-cluster/pkg/utils.BUILDTIME=2021-10-21/12:44:35 -s" -o bin/node ./cmd/node\nCGO_ENABLED=0 go build -installsuffix cgo -ldflags "-w -X github.com/IBM/operator-for-redis-cluster/pkg/utils.TAG=0.3.4 -X github.com/IBM/operator-for-redis-cluster/pkg/utils.COMMIT=81c58d3bb6e713679637d9971fc8f795ca5a3e2f -X github.com/IBM/operator-for-redis-cluster/pkg/utils.OPERATOR_VERSION= -X github.com/IBM/operator-for-redis-cluster/pkg/utils.REDIS_VERSION= -X github.com/IBM/operator-for-redis-cluster/pkg/utils.BUILDTIME=2021-10-21/12:44:37 -s" -o bin/metrics ./cmd/metrics\n'})}),"\n",(0,s.jsx)(r.p,{children:"Run the test suite to make sure everything works:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-console",children:"$ make test\n./go.test.sh\nok  \tgithub.com/IBM/operator-for-redis-cluster/pkg/controller\t5.162s\tcoverage: 33.1% of statements\nok  \tgithub.com/IBM/operator-for-redis-cluster/pkg/controller/clustering\t0.711s\tcoverage: 75.6% of statements\nok  \tgithub.com/IBM/operator-for-redis-cluster/pkg/controller/pod\t1.726s\tcoverage: 40.0% of statements\nok  \tgithub.com/IBM/operator-for-redis-cluster/pkg/controller/sanitycheck\t0.631s\tcoverage: 21.5% of statements\nok  \tgithub.com/IBM/operator-for-redis-cluster/pkg/garbagecollector\t1.740s\tcoverage: 75.0% of statements\nok  \tgithub.com/IBM/operator-for-redis-cluster/pkg/redis\t0.728s\tcoverage: 22.4% of statements\nok  \tgithub.com/IBM/operator-for-redis-cluster/pkg/redis/fake\t0.148s\tcoverage: 85.8% of statements\nok  \tgithub.com/IBM/operator-for-redis-cluster/pkg/redisnode\t1.924s\tcoverage: 43.4% of statements\n"})}),"\n",(0,s.jsxs)(r.p,{children:["Install the kubectl Redis cluster plugin (more info ",(0,s.jsx)(r.a,{href:"/operator-for-redis-cluster/kubectl-plugin",children:"here"}),")"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-console",children:"$ make plugin\n"})}),"\n",(0,s.jsx)(r.h2,{id:"create-a-kubernetes-cluster",children:"Create a Kubernetes cluster"}),"\n",(0,s.jsxs)(r.p,{children:["To run the Redis operator, you need to have a running Kubernetes cluster. You can use local k8s cluster frameworks such as ",(0,s.jsx)(r.code,{children:"kind"})," or ",(0,s.jsx)(r.code,{children:"minikube"}),". Use the following guide to install a ",(0,s.jsx)(r.code,{children:"kind"})," cluster similar to what we use in our e2e tests."]}),"\n",(0,s.jsx)(r.p,{children:"From the project root directory, create your kind cluster using the e2e test configuration:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-console",children:"$ kind create cluster --config ./test/e2e/kind_config.yml\n"})}),"\n",(0,s.jsx)(r.p,{children:"Build the required docker images (with optional PREFIX and PLATFORM):"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-console",children:"make container PREFIX=cinple/ TAG=latest PLATFORM=linux/amd64\n"})}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:["The default PLATFORM is linux/amd64. To build for Apple Silicon (M1/M2), use ",(0,s.jsx)(r.code,{children:"PLATFORM=linux/arm64"}),"."]}),"\n",(0,s.jsxs)(r.li,{children:["The PREFIX variable lets you namespace your images (e.g., ",(0,s.jsx)(r.code,{children:"cinple/"}),")."]}),"\n"]}),"\n",(0,s.jsx)(r.p,{children:"Once the kind cluster is up and running, load the images into the kind cluster:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-console",children:"$ kind load docker-image cinple/operator-for-redis-cluster-operator:latest\n$ kind load docker-image cinple/operator-for-redis-cluster-node:latest\n$ kind load docker-image cinple/operator-for-redis-cluster-metrics:latest\n"})}),"\n",(0,s.jsx)(r.h3,{id:"deploy-a-redis-operator",children:"Deploy a Redis operator"}),"\n",(0,s.jsxs)(r.p,{children:["Install the ",(0,s.jsx)(r.code,{children:"operator-for-redis"})," Helm chart:"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-console",children:"$ helm install op charts/operator-for-redis --wait --set image.repository=cinple/operator-for-redis-cluster-operator --set image.tag=latest\nNAME: op\nLAST DEPLOYED: <date>\nNAMESPACE: default\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\n"})}),"\n",(0,s.jsx)(r.h3,{id:"notes-on-multi-architecture-builds",children:"Notes on Multi-Architecture Builds"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:["The Makefile now supports multi-architecture builds using ",(0,s.jsx)(r.code,{children:"docker buildx"})," and the ",(0,s.jsx)(r.code,{children:"PLATFORM"})," variable."]}),"\n",(0,s.jsxs)(r.li,{children:["Example for Apple Silicon (M1/M2):","\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-console",children:"make container-operator PLATFORM=linux/arm64\n"})}),"\n"]}),"\n",(0,s.jsx)(r.li,{children:"All Go binaries and Docker images will be built for the specified platform."}),"\n"]}),"\n",(0,s.jsx)(r.p,{children:"Confirm that the operator is running properly:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-console",children:"$ kubectl get pods\nNAME                                     READY   STATUS    RESTARTS   AGE\nop-operator-for-redis-64dbfb4b59-xjttw   1/1     Running   0          31s\n"})}),"\n",(0,s.jsx)(r.h3,{id:"deploy-a-redis-cluster",children:"Deploy a Redis cluster"}),"\n",(0,s.jsxs)(r.p,{children:["Install the ",(0,s.jsx)(r.code,{children:"node-for-redis"})," Helm chart:"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-console",children:"$ helm install --wait cluster charts/node-for-redis --set image.repository=node-for-redis --set image.tag=latest\nNAME: cluster\nLAST DEPLOYED: Thu Oct 21 15:12:05 2021\nNAMESPACE: default\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\n"})}),"\n",(0,s.jsx)(r.p,{children:"Check the cluster status:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-console",children:"$ kubectl rc\n  POD NAME                                        IP           NODE        ID                                        ZONE   USED MEMORY  MAX MEMORY  KEYS  SLOTS\n  + rediscluster-cluster-node-for-redis-2h92v  10.244.1.89  172.18.0.3  5606ea9ab09678124a4b17de10ab92a78aac0b4d  dal13  35.55M       10.95G            5462-10923\n  | rediscluster-cluster-node-for-redis-nf24b  10.244.2.89  172.18.0.2  6840c0e5db16ebf073f57c67a6487c1c7f0d12d1  dal10  2.62M        10.95G\n  + rediscluster-cluster-node-for-redis-4h4s2  10.244.2.88  172.18.0.2  8a2f2db39b85cf059e88dc80d7c9cafefac94de0  dal10  34.63M       10.95G            10924-16383\n  | rediscluster-cluster-node-for-redis-77bt2  10.244.3.87  172.18.0.4  74582d0e0cedb458e81f1e9d4f32cdc3f5e9399b  dal12  2.60M        10.95G\n  + rediscluster-cluster-node-for-redis-dh6pt  10.244.3.86  172.18.0.4  81f5c13bec9a0545a62de08b2a309a87d29855c7  dal12  2.83M        10.95G            0-5461\n  | rediscluster-cluster-node-for-redis-jnh2h  10.244.1.88  172.18.0.3  ffae381633377414597731597518529255fd9b69  dal13  2.64M        10.95G\n\n  NAME                       NAMESPACE  PODS   OPS STATUS  REDIS STATUS  NB PRIMARY  REPLICATION  ZONE SKEW\n  cluster-node-for-redis  default    6/6/6  ClusterOK   OK            3/3         1-1/1        0/0/BALANCED\n"})}),"\n",(0,s.jsx)(r.h3,{id:"clean-up-your-environment",children:"Clean up your environment"}),"\n",(0,s.jsx)(r.p,{children:"Delete the Redis cluster:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-console",children:'$ helm uninstall cluster\nrelease "cluster" deleted\n'})}),"\n",(0,s.jsx)(r.p,{children:"Delete the Redis operator:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-console",children:'$ helm uninstall op\nrelease "op" deleted\n'})}),"\n",(0,s.jsx)(r.p,{children:"Ensure all pods have been deleted:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-console",children:"$ kubectl get pods\nNo resources found in default namespace.\n"})}),"\n",(0,s.jsx)(r.h2,{id:"run-end-to-end-tests",children:"Run end-to-end tests"}),"\n",(0,s.jsxs)(r.p,{children:["If you followed the steps for creating a ",(0,s.jsx)(r.code,{children:"kind"})," cluster with the e2e test configuration, then running the e2e tests is simple."]}),"\n",(0,s.jsx)(r.p,{children:"Build the required docker images:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-console",children:"make container PREFIX=cinple/ TAG=local\nmake container-node PREFIX=cinple/ TAG=new\n"})}),"\n",(0,s.jsxs)(r.p,{children:["Note that we need both ",(0,s.jsx)(r.code,{children:"local"})," and ",(0,s.jsx)(r.code,{children:"new"})," image tags for a rolling update e2e test case."]}),"\n",(0,s.jsx)(r.p,{children:"Load the required images into the kind cluster:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-console",children:"$ kind load docker-image cinple/operator-for-redis-cluster-operator:local\n$ kind load docker-image cinple/operator-for-redis-cluster-node:local\n$ kind load docker-image cinple/operator-for-redis-cluster-node:new\n"})}),"\n",(0,s.jsxs)(r.p,{children:["Once the kind cluster is up and running, deploy the ",(0,s.jsx)(r.code,{children:"operator-for-redis-cluster"})," Helm chart:"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-console",children:"$ helm install op charts/operator-for-redis --wait --set image.repository=cinple/operator-for-redis-cluster-operator --set image.tag=local\nNAME: op\nLAST DEPLOYED: <date>\nNAMESPACE: default\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\n"})}),"\n",(0,s.jsxs)(r.p,{children:["When the ",(0,s.jsx)(r.code,{children:"operator-for-redis"})," pod is up and running, you can start the e2e regression:"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-console",children:'$ go test -timeout 30m ./test/e2e --kubeconfig=$HOME/.kube/config --ginkgo.v --test.v\nRunning Suite: RedisCluster Suite\n=================================\nRandom Seed: 1634845111\nWill run 11 of 11 specs\n\nOct 21 15:38:31.261: INFO: KubeconfigPath-> "/Users/kscharm/.kube/config"\nOct 21 15:38:31.295: INFO: Check whether RedisCluster resource is registered...\nRedisCluster CRUD operations\n  should create a RedisCluster\n  \n...\n\nRan 11 of 11 Specs in 517.299 seconds\nSUCCESS! -- 11 Passed | 0 Failed | 0 Pending | 0 Skipped\nPASS\nok  \tgithub.com/IBM/operator-for-redis-cluster/test/e2e\t517.776s\n'})})]})}function u(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},8453:(e,r,o)=>{o.d(r,{R:()=>l,x:()=>i});var n=o(6540);const s={},t=n.createContext(s);function l(e){const r=n.useContext(t);return n.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function i(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),n.createElement(t.Provider,{value:r},e.children)}}}]);